<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Not Mandatory</title>
    <meta name="description"
          content="Steve Myers blog and current contact information.">

    <link rel="stylesheet" href="/main.css">
    <link rel="stylesheet" href="/fa-all.css">

    <link rel="apple-touch-icon" sizes="57x57" href="/img/icon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/img/icon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/img/icon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/img/icon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/img/icon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/img/icon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/img/icon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/img/icon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/icon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/img/icon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/img/icon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/img/icon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/icon/favicon-16x16.png">
    <link rel="manifest" href="/img/icon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/img/icon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

</head>

<body>

<header class="site-header">

    <div class="wrapper">

        <a class="site-title" href="https:&#x2F;&#x2F;notmandatory.org/">
            <img src="/img/notmandatory.jpg" alt="Not Mandatory">
        </a>

        <nav class="site-nav">
            <div class="trigger">
                
                <a class="page-link" href="https:&#x2F;&#x2F;notmandatory.org&#x2F;">Home</a>
                
                
                
                
                <a class="page-link" href="https:&#x2F;&#x2F;notmandatory.org&#x2F;about&#x2F;">About</a>
                
                
                
            </div>
        </nav>

    </div>

</header>

<div class="page-content">
    <div class="wrapper">

        
<div class="post">

  <header class="post-header">
    <h1 class="post-title">ROCKPro64 System, Part 3</h1>
    <p class="post-meta">Apr 6, 2020</p>
  </header>

  <article class="post-content">
    <p>In this post I detail the steps needed to enable fan control, install electrs Electrum personal server, and install and
configure nginx to provide an SSL proxy for the electrs server, to make it easy to use with the Electrum client software. </p>
<ol>
<li>
<p>enable the case fan using Active Thermal Service, follow <a href="https://github.com/tuxd3v/ats">github instruction</a></p>
</li>
<li>
<p>install c language and git (if not already installed)</p>
<pre><code>sudo apt install clang git
</code></pre>
</li>
<li>
<p>install rust tools per <a href="https://www.rust-lang.org/tools/install">rust-lang.org/tools/install</a> instructions</p>
<pre><code>curl --proto &#x27;=https&#x27; --tlsv1.2 -sSf https:&#x2F;&#x2F;sh.rustup.rs | sh
source $HOME&#x2F;.cargo&#x2F;env
</code></pre>
</li>
<li>
<p>clone and build the <a href="https://github.com/romanz/electrs">electrs</a> project</p>
<pre><code>git clone https:&#x2F;&#x2F;github.com&#x2F;romanz&#x2F;electrs.git
cd electrs
cargo build --release
</code></pre>
</li>
<li>
<p>add a new <code>electrs</code> system user and make it part of bitcoin group</p>
<pre><code>sudo adduser --system --home &#x2F;var&#x2F;lib&#x2F;electrs --ingroup bitcoin electrs
</code></pre>
</li>
<li>
<p>create a new LVM logical volume for electrs data, I allocate 40% of bitcoin volume size which is needed during 
indexing, but can lowered later after the indexes are compacted if I need the space back. </p>
<pre><code>sudo lvcreate -n electrs -L 200g rockpro64
</code></pre>
</li>
<li>
<p>format my new electrs logical volume, identify it's UUID and mount it via fstab</p>
<pre><code>sudo mkfs.ext4 &#x2F;dev&#x2F;rockpro64&#x2F;electrs
sudo blkid
sudo vi &#x2F;etc&#x2F;fstab
</code></pre>
<p>add line to /etc/fstab:</p>
<pre><code>UUID=&lt;THE UUID OF MY NEW LOGICAL PARTITION&gt; &#x2F;var&#x2F;lib&#x2F;electrs ext4 errors=remount-ro 0 1
</code></pre>
<pre><code>sudo mount -a
sudo chown electrs:bitcoin &#x2F;var&#x2F;lib&#x2F;electrs
sudo chmod -R o-rwx &#x2F;var&#x2F;lib&#x2F;electrs
sudo chmod u+rxw &#x2F;var&#x2F;lib&#x2F;electrs
sudo chmod g+x &#x2F;var&#x2F;lib&#x2F;electrs
</code></pre>
</li>
<li>
<p>copy electrs binary to /var/lib/electrs</p>
<pre><code>sudo mkdir &#x2F;var&#x2F;lib&#x2F;electrs&#x2F;bin
sudo chown electrs:bitcoin &#x2F;var&#x2F;lib&#x2F;electrs&#x2F;bin
sudo cp target&#x2F;release&#x2F;electrs &#x2F;var&#x2F;lib&#x2F;electrs&#x2F;bin
sudo chown electrs:bitcoin &#x2F;var&#x2F;lib&#x2F;electrs&#x2F;bin&#x2F;electrs
</code></pre>
</li>
<li>
<p>create systemd startup file for electrs </p>
<pre><code>sudo vi &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;electrs.service
</code></pre>
<p>and add below content to file</p>
<pre><code>[Unit]
Description=Electrs
After=bitcoind.service

[Service]
WorkingDirectory=&#x2F;var&#x2F;lib&#x2F;electrs
ExecStart=&#x2F;var&#x2F;lib&#x2F;electrs&#x2F;bin&#x2F;electrs -vvv --db-dir .&#x2F;db --index-batch-size=10 --jsonrpc-import --cookie-file &#x2F;var&#x2F;lib&#x2F;bitcoind&#x2F;.cookie --daemon-dir &#x2F;var&#x2F;lib&#x2F;bitcoind --electrum-rpc-addr=&quot;127.0.0.1:50001&quot;
User=electrs
Group=bitcoin
Type=simple
KillMode=process
TimeoutSec=60
Restart=always
RestartSec=60

[Install]
WantedBy=multi-user.target
</code></pre>
</li>
<li>
<p>edit the bitcoind service to enable the rpc server, restart bitcoind</p>
<pre><code>sudo vi &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;bitcoind.service
</code></pre>
<p>add <code>-server=1</code> to the ExecStart line</p>
<pre><code>sudo systemctl daemon-reload
sudo systemctl restart bitcoind
</code></pre>
</li>
<li>
<p>update the permission for bitcoind .cookie file so electrs can use it to connect to the bitcoind rpc api</p>
<pre><code>sudo chmod -R g+r &#x2F;var&#x2F;lib&#x2F;bitcoind&#x2F;
sudo chmod g+x &#x2F;var&#x2F;lib&#x2F;bitcoind
sudo chmod g+x &#x2F;var&#x2F;lib&#x2F;bitcoind&#x2F;blocks &#x2F;var&#x2F;lib&#x2F;bitcoind&#x2F;chainstate &#x2F;var&#x2F;lib&#x2F;bitcoind&#x2F;database
</code></pre>
</li>
<li>
<p>create /run/electrs directory, reload systemd services and start the electrs daemon</p>
<pre><code>sudo mkdir &#x2F;run&#x2F;electrs
sudo chown electrs:bitcoin &#x2F;run&#x2F;electrs
sudo systemctl daemon-reload
sudo syste:qqmctl start electrs
</code></pre>
<p>At this point electrs will start indexing, this took almost 24 hours on my system. </p>
</li>
<li>
<p>install nginx</p>
<pre><code>sudo apt install nginx
</code></pre>
</li>
<li>
<p>create a new nginx cert</p>
<pre><code>sudo mkdir &#x2F;etc&#x2F;nginx&#x2F;ssl
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout &#x2F;etc&#x2F;nginx&#x2F;ssl&#x2F;nginx.key -out &#x2F;etc&#x2F;nginx&#x2F;ssl&#x2F;nginx.crt
</code></pre>
</li>
<li>
<p>add the below block to the nginx config file</p>
<p>sudo vi /etc/nginx/nginx.conf</p>
<pre><code>stream {
        upstream electrs {
                server 127.0.0.1:50001;
        }

        server {
                listen 50002 ssl;
                proxy_pass electrs;

                ssl_certificate &#x2F;etc&#x2F;nginx&#x2F;ssl&#x2F;nginx.crt;
                ssl_certificate_key &#x2F;etc&#x2F;nginx&#x2F;ssl&#x2F;nginx.key;
                ssl_session_cache shared:SSL:1m;
                ssl_session_timeout 4h;
                ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
                ssl_prefer_server_ciphers on;
        }
}
</code></pre>
</li>
<li>
<p>unlink the nginx default site in the sites-active directory and restart nginx</p>
<pre><code>sudo rm &#x2F;etc&#x2F;nginx&#x2F;sites-enabled&#x2F;default
sudo systemctl restart nginx
</code></pre>
</li>
</ol>
<p>Done! I now have an electrum server at https://localhost:50001 that I can use as a back end to an electrum client, 
or any other service that uses the electrum server apis to browse the bitcoin block chain.</p>

  </article>

</div>


    </div>
</div>

<footer class="site-footer">

    <div class="wrapper">

        <div class="footer-col-wrapper">
            <div class="footer-col  footer-col-1">
                <ul class="contact-list">
                    <li><a href="mailto:steve@notmandatory.org">steve@notmandatory.org</a></li>
                    
                    <li>gpg fingerprint: D9FF 9010 BE16 9B64 D3ED  CBF9 8105 A46B 22C2 D051</li>
                    
                </ul>
            </div>

            <div class="footer-col  footer-col-2">
                <ul class="social-media-list">
                    
                    
                    <li>
                        <a href="https://github.com/notmandatory">
                            <span class="fab fa-github fa-lg"></span>
                            <span class="username">notmandatory</span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://bitcoinhackers.org/@notmandatory">
                            <span class="fab fa-mastodon fa-lg"></span>
                            <span class="username">notmandatory</span>
                            <span class="username">@bitcoinhackers.org</span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://twitter.com/notmandatory">
                            <span class="fab fa-twitter-square fa-lg"></span>
                            <span class="username">notmandatory</span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="&#x2F;steve_notmandatory.gpg">
                            <span class="fas fa-user-secret fa-lg"></span>
                            <span class="username">gpg public key</span>
                        </a>
                    </li>
                    
                </ul>
            </div>

            <div class="footer-col  footer-col-3">
                <p class="text">Steve Myers blog and current contact information.</p>
            </div>
        </div>

    </div>

</footer>

</body>
